---
title: "Estimate yield based on a slot limit"
author: "Jason Doll"
date: "`r Sys.Date()`"
format: 
  html: 
    code-fold: false
    toc: true
    toc-depth: 2
    reference-location: margin
knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
    echo: true
    fig-width: 7.5
    fig-height: 4.5
    fig-align: center
---

```{r}
#| label: setup
#| results: hide
#| message: false
library(rFAMS)
library(ggplot2)  ## to make figures
library(tidyr)    ## for pivot_longer
library(dplyr)    ## for filter
```

The objective of this article is to demonstrate how to use rFAMS to calculate yield based on a slot length limit with multiple values of conditional fishing and conditional natural mortality. Separate conditional fishing mortality for fish under slot, within slot, and above slot must be specified. This allows the user to investigate a protective slot where fish are protected from harvest within a length range and an inverted slot where small fish under the slot and large fish over the slot limit are protected while harvesting is allowed within the slot limit.

# Build a life history parameter list
The first step for using any of the rFAMS simulation models is to create an object with life history parameters using the `makeLH()` function. THe `makeLH()` function creates a list of the life history parameters needed. Including, the initial number of recruits, maximum age of fish in your population, von Bertalanffy growth model parameters ($L_\infty$, $K$, and $t_0$), and parameters from the log10-transformed weight length model (alpha and beta). By default, the `makeLH()` returns a list. These values can be generated from functions in the [FSA package](https://fishr-core-team.github.io/FSA/index.html). The example below uses the following life history parameters:

- NO is the initial number of recruits, set to 100.
- tmax is the maximum age in the population in years, set to 15.
- Linf is the point estimate of asymptotic mean length from the von Bertalanffy growth model, set to 592mm.
- K (upper case) is the point estimate of the Brody growth coefficient from the von Bertalanffy growth model, set to 0.20.
- t0 is the point estimate of the x-intercept (i.e., theoretical age at a mean length of 0) from the von Bertalanffy growth model, set to -0.3.
- LWalpha is the point estimate of alpha from the length-weight regression on the log10 scale, set to -5.528.
- LWbeta is the point estimate of beta from the length-weight regression on the log10 scale, set to 3.273.

```{r}
#| label: Create life history object
# create life history parameter object
LH <- makeLH(N0=100,tmax=15,Linf=592,K=0.20,t0=-0.3,LWalpha=-5.528,LWbeta=3.273)
```

# Estimate yield for one minimum length limit and variable conditional fishing and conditional natural mortality.

The function `yprBH_SlotLL()` function is used when yield is estimated with a slot limit and conditional fishing mortality is specified below, within, and above the slot. This function requires a recruitment length `recruitmentTL` (i.e., the length where fish are susceptible to harvest, this is NOT the lower slot limi); lower slot limit `lowerSL`; upper slot limit `upperSL`; conditional fishing mortality under the slot limit but above recruitment length `cfunder`; conditional fishing mortality within the slot limit `cfin`; conditional fishing mortality above the slot limit `cfabove`; specified range of conditional natural mortality by setting the minimum `cmmin`, maximum `cmmax`, and increment `cminc`; set any length of interest to monitor `loi`; and the life history parameters `lhparams`.

rFAMS includes a function `est_natmort()` to estimate instantaneous natural mortality (M) and conditional natural mortality (cm) using parameters specified in the life history parameter object. See the [FSA package](https://fishr-core-team.github.io/FSA/index.html) for other methods of calculating M and cm. To generate the range and average M and cm using rFAMS:

```{r}
#| label: estimate natural mortality
est_natmort(LH, incl.avg = TRUE)
```

Once you have decided the range of cf and cm and decided what minimum length limit to consider, you can now proceed to estimating yield. The following example uses the life history object created above with a minimum length limit of 200mm, cf from 0.1 to 0.9 with increments of 0.1, cm from 0.1 to 0.9 with increments of 0.1, monitors lengths of 200, 250, 300, and 350mm.

```{r}
#| label: estimate yield
Res_1 <- yprBH_SlotLL(recruitmentTL=200,lowerSL=250,upperSL=325, #Set recruitment and slot limit length
                      cfunder=0.25,cfin=0.6,cfabove=0.15,        #Set cf under, in, and above slot limit
                      cmmin=0.1,cmmax=0.9,cminc=0.1,             #creates vector of cm values
                      loi=c(200,250,300,350,450,550),         #sets lengths of interest to monitor
                      lhparms=LH)                     #Specifies life history parameters
```

The output object will be a data.frame with the following calculated values:

- cm A numeric representing conditional natural mortality
- TotalYield is the calculated total yield
- TotalHarvest is the calculated total number of harvested fish
- TotalNdie is the calculated total number of fish that die of natural death
- yieldUnder is the calculated yield under the slot limit
- yieldIn is the calculated yied within the slot limit
- yieldAbove is the calculated yield above the slot limit
- exploitationUnder is the exploitation rate under the slot limit
- exploitationIn is the exploitation rate within the slot limit
- exploitationAbove is the exploitation rate above the slot limit
- NharvestUnder is the number of harvested fish under the slot limit
- NharvestIn is the number of harvested fish within the slot limit
- NharvestAbove is the number of harvested fish above the slot limit
- NdieUnder is the number of fish that die of natural death under the slot limit
- NdieIn is the number of fish that die of natural deaths within the slot limit
- NdieAbove is the number of fish that die of natural deaths above the slot limit
- avglenUnder is the average length of fish harvested under the slot limit
- avglenIn is the average length of fish harvested within the slot limit
- avglenAbove is the average length of fish harvested above the slot limit
- avgwtUnder is the average weight of fish harvested under the slot limit
- avgwtIn is the average weight of fish harvested within the slot limit
- avgwtAbove is the average weight of fish harvested above the slot limit
- trUnder is the time for a fish to recruit to a minimum length limit (i.e., time to enter fishery)
- trIn is the time for a fish to recruit to a lower length limit of the slot limit
- trOver is the time for a fish to recruit to a upper length limit of the slot limit
- NtUnder is the number of fish at time trUnder (time they become harvestable size under the slot limit)
- NtIn is the number of fish at time trIn (time they reach the lower slot limit size)
- NtAbove is the number of fish at time trAbove (time they reach the upper slot limit size)
- FUnder is the estimated instantaneous rate of fishing mortality under the slot limit
- FIn is the estimated instantaneous rate of fishing mortality within the slot limit
- FAbove is the estimated instantaneous rate of fishing mortality above the slot limit
- MUnder is the estimated instantaneous rate of natural mortality under the slot limit
- MIn is the estimated instantaneous rate of natural mortality within the slot limit
- MAbove is the estimated instantaneous rate of natural mortality above the slot limit
- ZUnder is the estimated instantaneous rate of total mortality under the slot limit
- ZIn is the estimated instantaneous rate of total mortality within the slot limit
- ZAbove is the estimated instantaneous rate of total mortality above the slot limit
- SUnder is the estimated total survival under the slot limit
- SIn is the estimated total survival within the slot limit
- SAbove is the estimated total survival above the slot limit
- cfUnder A numeric representing conditional fishing mortality
- cfIn A numeric representing conditional fishing mortality
- cfOver A numeric representing conditional fishing mortality
- recruitmentTL A numeric representing the minimum length limit for recruiting to the fishery in mm.
- lowerSL A numeric representing the length of the lower slot limit in mm.
- upperSL A numeric representing the length of the upper slot limit in mm.
- N at xxx mm is the number that reach the length of interest supplied. There will be one column for each length of interest.

For convenience the data.frame also contains the model input values (cf derived from cfUnder, cfIn, and cfOver; recruitmentTL; lowerSL; upperSL; cm derived from cmmin, cmmax, and cminc; N0; Linf; K; t0; LWalpha; LWbeta; and tmax).

View the first few rows of the output

```{r}
#| label: view results
head(Res_1)
```

# Plot results

We will now create a series of figures to aid in interpreting the output. First, a custom theme is created to use across all plots.

```{r}
#| label: create custom plot
# Custom theme for plots (to make look nice)
theme_FAMS <- function(...) {
 theme_bw() +
 theme(
   panel.grid.major=element_blank(),panel.grid.minor=element_blank(),
   axis.text=element_text(size=14,color="black"),
   axis.title=element_text(size=16,color="black"),
   axis.title.y=element_text(angle=90),
   axis.line=element_line(color="black"),
   panel.border=element_blank()
 )
}
```

## Yield as a function of conditional natural mortality

The first figure will be a yield curve that displays the relationship between yield as a function of conditional natural mortality.

```{r}
#| label: generate yield plot
# Total Yield vs Conditional Natural Mortality (cm)
ggplot(data=Res_1,mapping=aes(x=cm,y=TotalYield)) +
  geom_point() +
  geom_line() +
  labs(y="Total yield (g)",x="Conditional natural mortality (cm)") +
  theme_FAMS()
```

## Number of fish that reach a specified size as a function of conditional natural mortality

The next figure demonstrates how to explore the number of fish reaching a specified length. This figure creates a plot showing the number of fish reaching 350mm as a function of conditional natural mortality.

```{r}
#| label: Plot of fish reaching 350mm
#Plot number of fish reaching 350 mm as a function of cm
ggplot(data=Res_1,mapping=aes(x=cm ,y=`N at 350 mm`)) +
  geom_point() +
  geom_line() +
  labs(y="Number of fish at 450 mm",x="Conditional natural mortality (cm )") +
  theme_FAMS()
```

The last example figure plots yield as a function of conditional natural mortality across the three size classes; above slot limit, within slot limit, and above slot limit. 

```{r}
#| label: Plot of yield across all sizes
# Yield under, in, and above the slot limit vs Conditional Natural Mortality (cm)
# Select columns for plotting
plot_data <- Res_1 %>%
  select(cm, yieldUnder, yieldIn, yieldAbove) %>%
  pivot_longer(!cm, names_to="YieldCat",values_to="Yield")

# Generate plot
ggplot(data=plot_data,mapping=aes(x=cm,y=Yield,group=YieldCat,color=YieldCat)) +
  geom_point() +
  scale_color_discrete(name="Yield",labels=c("Above SL","Within SL","Under SL"))+
  geom_line() +
  labs(y="Total yield (g)",x="Conditional natural mortality (cm)") +
  theme_FAMS() +
  theme(legend.position = "top")+
  guides(color=guide_legend(title="Slot limit"))
```
